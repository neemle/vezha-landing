<div class="admin-shell">
  <header class="admin-header">
    <div>
      <p class="eyebrow">VEZHA 360</p>
      <h1>Content admin</h1>
      <p class="muted">Edit landing copy per locale without touching JSON. Drag blocks to reorder.</p>
    </div>
    <a routerLink="/" class="link">← Back to landing</a>
  </header>

  <section class="card token-card" [formGroup]="tokenForm">
    <label>
      <span>Admin token</span>
      <input type="password" formControlName="adminToken" placeholder="x-admin-token" />
    </label>
    <p class="help">Token is stored locally to authorize admin API calls.</p>
    <div class="token-actions">
      <button class="primary" type="button" (click)="saveToken()" [disabled]="tokenForm.invalid">Save token</button>
    </div>
  </section>

  <form class="card content-card" [formGroup]="selectedContent().form" (ngSubmit)="saveLocale(activeLocale())" novalidate>
    <datalist id="fa-icons-list">
      @for (icon of iconOptions; track icon) {
        <option [value]="icon">{{ icon }}</option>
      }
    </datalist>
    <div class="card-head content-head">
      <div>
        <p class="eyebrow">Content</p>
        <h2>Visual content builder</h2>
        <p class="muted">Select a locale, edit blocks, and drag to reorder list items.</p>
      </div>
      <div class="card-actions content-actions">
        <label class="stacked">
          <span>Locale</span>
          <select [value]="activeLocale()" (change)="switchLocale($any($event.target).value)">
            @for (locale of locales(); track locale) {
              <option [value]="locale">{{ locale.toUpperCase() }}</option>
            }
          </select>
        </label>
        <button class="ghost" type="button" (click)="loadLocale(activeLocale())" [disabled]="selectedContent().loading()">
          {{ selectedContent().loading() ? 'Loading…' : 'Reload' }}
        </button>
        <button class="primary" type="submit" [disabled]="selectedContent().saving()">
          {{ selectedContent().saving() ? 'Saving…' : 'Save content' }}
        </button>
      </div>
      <div class="locale-add" [formGroup]="localeForm">
        <label>
          <span>New locale code</span>
          <input formControlName="newLocale" placeholder="e.g. pl or fr" />
        </label>
        <button class="ghost" type="button" (click)="addLocale()" [disabled]="localeForm.invalid">Add locale (copies EN)</button>
      </div>
    </div>

    @if (selectedContent().error()) {
      <div class="banner danger">{{ selectedContent().error() }}</div>
    }
    @if (selectedContent().success()) {
      <div class="banner success">{{ selectedContent().success() }}</div>
    }

    <div class="editor-grid">
      <label class="checkbox">
        <input type="checkbox" formControlName="active" />
        <span>Locale is active</span>
      </label>

      <div class="section" formGroupName="hero">
        <div class="section-head">
          <div>
            <p class="eyebrow">Hero</p>
            <p class="muted">Headline, CTA, badge, and hero bullet list.</p>
          </div>
        </div>
        <div class="field-grid two-col">
          <label>
            <span>Title</span>
            <input formControlName="title" />
          </label>
          <label>
            <span>Subtitle</span>
            <textarea rows="2" formControlName="subtitle"></textarea>
          </label>
          <label>
            <span>Badge</span>
            <input formControlName="badge" />
          </label>
          <label>
            <span>Price note</span>
            <input formControlName="priceNote" />
          </label>
          <label>
            <span>Primary CTA</span>
            <input formControlName="primaryCta" />
          </label>
          <label>
            <span>Telegram label</span>
            <input formControlName="telegramLabel" />
          </label>
          <label>
            <span>Email label</span>
            <input formControlName="emailLabel" />
          </label>
          <label>
            <span>Telegram URL</span>
            <input formControlName="telegramUrl" />
          </label>
          <label>
            <span>Hero email</span>
            <input formControlName="email" />
          </label>
        </div>
        <div class="list-block">
          <div class="section-subhead">
            <div>
              <p class="eyebrow">Hero bullets</p>
              <p class="muted">Drag to change order.</p>
            </div>
            <button class="ghost" type="button" (click)="addHeroBullet(activeLocale())">Add bullet</button>
          </div>
          <div formArrayName="bullets" class="draggable-list">
            @for (bullet of selectedContent().form.controls.hero.controls.bullets.controls; track bullet) {
              <div
                class="draggable-row"
                draggable="true"
                (dragstart)="startDrag($event, 'heroBullets', $index, activeLocale())"
                (dragover)="allowDrop($event)"
                (drop)="dropItem($event, 'heroBullets', $index, activeLocale())"
                (dragend)="endDrag()"
              >
                <span class="drag-handle" aria-hidden="true">↕</span>
                <input [formControlName]="$index" placeholder="Bullet text" />
                <button class="ghost danger" type="button" (click)="removeHeroBullet(activeLocale(), $index)">Delete</button>
              </div>
            }
          </div>
        </div>
      </div>

      <div class="section" formArrayName="painPoints">
        <div class="section-head">
          <div>
            <p class="eyebrow">Pain points</p>
            <p class="muted">Add, edit, and reorder cards.</p>
          </div>
          <button class="ghost" type="button" (click)="addPainPoint(activeLocale())">Add block</button>
        </div>
        <div class="block-list">
          @for (group of selectedContent().form.controls.painPoints.controls; track group) {
            <div
              class="block"
              [formGroupName]="$index"
              draggable="true"
              (dragstart)="startDrag($event, 'painPoints', $index, activeLocale())"
              (dragover)="allowDrop($event)"
              (drop)="dropItem($event, 'painPoints', $index, activeLocale())"
              (dragend)="endDrag()"
            >
              <div class="block-head">
                <span class="drag-handle" aria-hidden="true">↕</span>
                <p class="muted">Block {{ $index + 1 }}</p>
                <button class="ghost danger" type="button" (click)="removePainPoint(activeLocale(), $index)">Delete</button>
              </div>
              <div class="field-grid three-col">
                <label>
                  <span>Title</span>
                  <input formControlName="title" />
                </label>
                <label>
                  <span>Description</span>
                  <textarea rows="2" formControlName="description"></textarea>
                </label>
                <label>
                  <span>Icon</span>
                  <div class="icon-input">
                    <input formControlName="icon" [attr.list]="'fa-icons-list'" placeholder="fa-shield-halved" />
                    <span class="icon-preview">
                      @if (isFaIcon(group.controls.icon.value)) {
                        <i class="fa-solid" [ngClass]="group.controls.icon.value"></i>
                      } @else {
                        <span class="icon-text">{{ group.controls.icon.value || '•' }}</span>
                      }
                    </span>
                  </div>
                </label>
              </div>
            </div>
          }
        </div>
      </div>

      <div class="section" formArrayName="features">
        <div class="section-head">
          <div>
            <p class="eyebrow">Features</p>
            <p class="muted">Visual list of advantages.</p>
          </div>
          <button class="ghost" type="button" (click)="addFeature(activeLocale())">Add feature</button>
        </div>
        <div class="block-list">
          @for (group of selectedContent().form.controls.features.controls; track group) {
            <div
              class="block"
              [formGroupName]="$index"
              draggable="true"
              (dragstart)="startDrag($event, 'features', $index, activeLocale())"
              (dragover)="allowDrop($event)"
              (drop)="dropItem($event, 'features', $index, activeLocale())"
              (dragend)="endDrag()"
            >
              <div class="block-head">
                <span class="drag-handle" aria-hidden="true">↕</span>
                <p class="muted">Block {{ $index + 1 }}</p>
                <button class="ghost danger" type="button" (click)="removeFeature(activeLocale(), $index)">Delete</button>
              </div>
              <div class="field-grid three-col">
                <label>
                  <span>Title</span>
                  <input formControlName="title" />
                </label>
                <label>
                  <span>Description</span>
                  <textarea rows="2" formControlName="description"></textarea>
                </label>
                <label>
                  <span>Icon</span>
                  <div class="icon-input">
                    <input formControlName="icon" [attr.list]="'fa-icons-list'" placeholder="fa-bolt" />
                    <span class="icon-preview">
                      @if (isFaIcon(group.controls.icon.value)) {
                        <i class="fa-solid" [ngClass]="group.controls.icon.value"></i>
                      } @else {
                        <span class="icon-text">{{ group.controls.icon.value || '•' }}</span>
                      }
                    </span>
                  </div>
                </label>
              </div>
            </div>
          }
        </div>
      </div>

      <div class="section" formGroupName="comparison">
        <div class="section-head">
          <div>
            <p class="eyebrow">Comparison</p>
            <p class="muted">Sysadmin vs Vezha copy.</p>
          </div>
        </div>
        <label>
          <span>Highlight</span>
          <input formControlName="highlight" />
        </label>
        <div class="comparison-grid">
          <div class="sub-card" formGroupName="sysadmin">
            <p class="eyebrow">Sysadmin</p>
            <div class="field-grid two-col">
              <label>
                <span>Title</span>
                <input formControlName="title" />
              </label>
              <label>
                <span>Description</span>
                <textarea rows="2" formControlName="description"></textarea>
              </label>
              <label>
                <span>Price</span>
                <input formControlName="price" />
              </label>
            </div>
          </div>
          <div class="sub-card" formGroupName="vezha">
            <p class="eyebrow">Vezha</p>
            <div class="field-grid two-col">
              <label>
                <span>Title</span>
                <input formControlName="title" />
              </label>
              <label>
                <span>Description</span>
                <textarea rows="2" formControlName="description"></textarea>
              </label>
              <label>
                <span>Price</span>
                <input formControlName="price" />
              </label>
              <label>
                <span>Badge</span>
                <input formControlName="badge" />
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="section" formGroupName="metrics">
        <div class="section-head">
          <div>
            <p class="eyebrow">Metrics</p>
            <p class="muted">Stats and proof points.</p>
          </div>
          <button class="ghost" type="button" (click)="addMetric(activeLocale())">Add stat</button>
        </div>
        <label>
          <span>Note</span>
          <input formControlName="note" />
        </label>
        <div formArrayName="stats" class="block-list compact">
          @for (group of selectedContent().form.controls.metrics.controls.stats.controls; track group) {
            <div
              class="block"
              [formGroupName]="$index"
              draggable="true"
              (dragstart)="startDrag($event, 'metricsStats', $index, activeLocale())"
              (dragover)="allowDrop($event)"
              (drop)="dropItem($event, 'metricsStats', $index, activeLocale())"
              (dragend)="endDrag()"
            >
              <div class="block-head">
                <span class="drag-handle" aria-hidden="true">↕</span>
                <p class="muted">Stat {{ $index + 1 }}</p>
                <button class="ghost danger" type="button" (click)="removeMetric(activeLocale(), $index)">Delete</button>
              </div>
              <div class="field-grid two-col">
                <label>
                  <span>Label</span>
                  <input formControlName="label" />
                </label>
                <label>
                  <span>Value</span>
                  <input formControlName="value" />
                </label>
              </div>
            </div>
          }
        </div>
      </div>

      <div class="section" formArrayName="howItWorks">
        <div class="section-head">
          <div>
            <p class="eyebrow">How it works</p>
            <p class="muted">Steps for the flow.</p>
          </div>
          <button class="ghost" type="button" (click)="addHowItWorks(activeLocale())">Add step</button>
        </div>
        <div class="block-list">
          @for (group of selectedContent().form.controls.howItWorks.controls; track group) {
            <div
              class="block"
              [formGroupName]="$index"
              draggable="true"
              (dragstart)="startDrag($event, 'howItWorks', $index, activeLocale())"
              (dragover)="allowDrop($event)"
              (drop)="dropItem($event, 'howItWorks', $index, activeLocale())"
              (dragend)="endDrag()"
            >
              <div class="block-head">
                <span class="drag-handle" aria-hidden="true">↕</span>
                <p class="muted">Step {{ $index + 1 }}</p>
                <button class="ghost danger" type="button" (click)="removeHowItWorks(activeLocale(), $index)">Delete</button>
              </div>
              <div class="field-grid two-col">
                <label>
                  <span>Title</span>
                  <input formControlName="title" />
                </label>
                <label>
                  <span>Description</span>
                  <textarea rows="2" formControlName="description"></textarea>
                </label>
              </div>
            </div>
          }
        </div>
      </div>

      <div class="section" formGroupName="contact">
        <div class="section-head">
          <div>
            <p class="eyebrow">Contact</p>
            <p class="muted">CTA copy and form labels.</p>
          </div>
        </div>
        <div class="field-grid two-col">
          <label>
            <span>Title</span>
            <input formControlName="title" />
          </label>
          <label>
            <span>Subtitle</span>
            <textarea rows="2" formControlName="subtitle"></textarea>
          </label>
          <label>
            <span>Thank you message</span>
            <input formControlName="thankYou" />
          </label>
          <label>
            <span>Telegram label</span>
            <input formControlName="telegramLabel" />
          </label>
          <label>
            <span>Telegram URL</span>
            <input formControlName="telegramUrl" />
          </label>
          <label>
            <span>Email label</span>
            <input formControlName="emailLabel" />
          </label>
          <label>
            <span>Email</span>
            <input formControlName="email" />
          </label>
        </div>

        <div class="sub-card" formGroupName="form">
          <p class="eyebrow">Form labels</p>
          <div class="field-grid three-col">
            <label>
              <span>Name label</span>
              <input formControlName="nameLabel" />
            </label>
            <label>
              <span>Email label</span>
              <input formControlName="emailLabel" />
            </label>
            <label>
              <span>Phone label</span>
              <input formControlName="phoneLabel" />
            </label>
            <label>
              <span>Message label</span>
              <input formControlName="messageLabel" />
            </label>
            <label>
              <span>Submit label</span>
              <input formControlName="submitLabel" />
            </label>
          </div>
          <div class="field-grid two-col" formGroupName="errors">
            <label>
              <span>Email required</span>
              <input formControlName="requiredEmail" />
            </label>
            <label>
              <span>Email invalid</span>
              <input formControlName="invalidEmail" />
            </label>
          </div>
        </div>
      </div>

      <div class="section" formGroupName="seo">
        <div class="section-head">
          <div>
            <p class="eyebrow">SEO</p>
            <p class="muted">Title and description tags.</p>
          </div>
        </div>
        <div class="field-grid two-col">
          <label>
            <span>SEO title</span>
            <input formControlName="title" />
          </label>
          <label>
            <span>SEO description</span>
            <textarea rows="2" formControlName="description"></textarea>
          </label>
        </div>
      </div>
    </div>
  </form>

  <section class="card leads-card">
    <div class="card-head">
      <div>
        <p class="eyebrow">Leads</p>
        <h2>Lead inbox & export</h2>
        <p class="help">Sort and filter leads. Only unexported, non-bad leads are exported.</p>
      </div>
      <div class="card-actions">
        <button class="ghost" type="button" (click)="loadLeads()" [disabled]="leadsLoading()">
          {{ leadsLoading() ? 'Loading...' : 'Refresh' }}
        </button>
        <button class="primary" type="button" (click)="exportLeads()" [disabled]="exporting()">
          {{ exporting() ? 'Exporting...' : 'Export CSV' }}
        </button>
      </div>
    </div>

    <div class="lead-filters">
      <label>
        <span>Exported status</span>
        <select [value]="leadFilters().exported" (change)="updateExportedFilter($any($event.target).value)">
          <option value="all">All</option>
          <option value="unexported">Unexported</option>
          <option value="exported">Exported</option>
        </select>
      </label>
      <label class="checkbox">
        <input
          type="checkbox"
          [checked]="leadFilters().includeBad"
          (change)="toggleIncludeBad($any($event.target).checked)"
        />
        <span>Show bad leads</span>
      </label>
      <label class="search">
        <span>Search</span>
        <input
          type="search"
          [value]="leadFilters().search"
          placeholder="Email, name, phone"
          (keyup.enter)="applySearch($any($event.target).value)"
          (blur)="applySearch($any($event.target).value)"
        />
      </label>
    </div>

    @if (leadsError()) {
      <div class="banner danger">{{ leadsError() }}</div>
    }
    @if (leadsSuccess()) {
      <div class="banner success">{{ leadsSuccess() }}</div>
    }
    @if (exportMessage()) {
      <div class="banner success">{{ exportMessage() }}</div>
    }

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th (click)="sortBy('createdAt')" role="button">Created</th>
            <th (click)="sortBy('name')" role="button">Name</th>
            <th (click)="sortBy('email')" role="button">Email</th>
            <th>Phone</th>
            <th>Message</th>
            <th>Lang</th>
            <th (click)="sortBy('exportedAt')" role="button">Exported</th>
            <th>Bad</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @if (leadsLoading()) {
            <tr>
              <td colspan="9" class="center muted">Loading leads...</td>
            </tr>
          } @else if (viewLeads().length === 0) {
            <tr>
              <td colspan="9" class="center muted">No leads found.</td>
            </tr>
          } @else {
            @for (lead of viewLeads(); track lead.id) {
              <tr>
                <td><span class="mono">{{ lead.createdAt | date: 'short' }}</span></td>
                <td>{{ lead.name || '—' }}</td>
                <td class="mono">{{ lead.email }}</td>
                <td>{{ lead.phone || '—' }}</td>
                <td class="message-cell">{{ lead.message || '—' }}</td>
                <td>{{ lead.lang?.toUpperCase() || '—' }}</td>
                <td>
                  @if (lead.exportedAt) {
                    <span class="mono">{{ lead.exportedAt | date: 'short' }}</span>
                  } @else {
                    <span class="pill muted">Not exported</span>
                  }
                </td>
                <td>
                  <span class="pill" [class.danger]="lead.bad" [class.success]="!lead.bad">
                    {{ lead.bad ? 'Bad' : 'Good' }}
                  </span>
                </td>
                <td>
                  <button class="ghost" type="button" (click)="toggleBad(lead)">
                    {{ lead.bad ? 'Mark good' : 'Mark bad' }}
                  </button>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  </section>
</div>
